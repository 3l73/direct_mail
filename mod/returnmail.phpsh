#! /usr/local/bin/php -q
<?php

$dir = dirname($HTTP_ENV_VARS["_"]);
$dir = "/var/www/html/directmaildev/typo3conf/ext/direct_mail/mod";
define("PATH_typo3", dirname(dirname(dirname(dirname($dir))))."/typo3/");
define("PATH_site", dirname(PATH_typo3)."/");
define("PATH_t3lib", PATH_typo3."t3lib/");
define("PATH_typo3conf", PATH_site."typo3conf/");	// Typo-configuraton path
define('TYPO3_MODE','BE');

/*
printf("Dir: ".$dir."\n");
printf("PATH_typo3: ".PATH_typo3."\n");
printf("PATH_site: ".PATH_site."\n");
printf("PATH_t3lib: ".PATH_t3lib."\n");
printf("PATH_typo3conf: ".PATH_typo3conf."\n");
exit;
*/
require(PATH_t3lib."class.t3lib_div.php");
require(PATH_t3lib."class.t3lib_extmgm.php");

require(PATH_t3lib."config_default.php");		
if (!defined ("TYPO3_db")) 	die ("The configuration file was not included.");

require(PATH_t3lib.'class.t3lib_db.php');		// The database library
$TYPO3_DB = t3lib_div::makeInstance('t3lib_DB');


$ext_path = t3lib_div::resolveBackPath('typo3/'.t3lib_extMgm::extRelPath('direct_mail'))."mod";
//if (substr($dir,strlen(PATH_site))!="typo3conf/ext/direct_mail/mod")	{
if (substr($dir,strlen(PATH_site))!=$ext_path)	{
	die("Wrong path... This '".substr($dir,strlen(PATH_site))."' should be the last part of '".$ext_path."'");
}
require_once (PATH_t3lib.'class.t3lib_readmail.php');		// The database library	
require_once (PATH_t3lib."class.t3lib_htmlmail.php");
require_once t3lib_div::resolveBackPath(t3lib_extMgm::extPath('direct_mail')).'mod/class.dmailer.php';

// Connect to the database
$result = $GLOBALS['TYPO3_DB']->sql_pconnect(TYPO3_db_host, TYPO3_db_username, TYPO3_db_password); 
if (!$result)	{
	die("Couldn't connect to database at ".TYPO3_db_host);
}
$GLOBALS['TYPO3_DB']->sql_select_db(TYPO3_db);




// MAIL CONTENT
$filename = "php://stdin";

$content = t3lib_div::getUrl($filename);
if (trim($content))	{
	$readMail = t3lib_div::makeInstance("t3lib_readmail");
	
		// Split mail into head and content
	$mailParts = $readMail->extractMailHeader($content);
		// Find id
	$midArr = $readMail->find_XTypo3MID($content);
	if (!is_array($midArr))	{
		$midArr = $readMail->find_MIDfromReturnPath($mailParts["to"]);
	}

		// Extract text content
	$c=trim($readMail->getMessage($mailParts));
	$cp=$readMail->analyseReturnError($c);

	$temp_res = $GLOBALS['TYPO3_DB']->exec_SELECTquery('uid', 'sys_dmail_maillog', 'rid='.intval($midArr['rid']).' AND rtbl="'.$GLOBALS['TYPO3_DB']->quoteStr($midArr['rtbl'], 'sys_dmail_maillog').'" AND mid='.intval($midArr['mid']).' AND response_type=0');
	if (!$GLOBALS['TYPO3_DB']->sql_num_rows($temp_res))		{
		$midArr = array();
		$cp = $mailParts;
	}
	
	$insertFields = array(
		'tstamp' => time(),
		'response_type' => -127,
		'mid' => $midArr['mid'],
		'rid' => $midArr['rid'],
		'rtbl' => $midArr['rtbl'],
		'return_content' => serialize($cp),
		'return_code' => intval($cp['reason'])
	);
	
	$GLOBALS['TYPO3_DB']->exec_INSERTquery('sys_dmail_maillog', $insertFields);
}

?>